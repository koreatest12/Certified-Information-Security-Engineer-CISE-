name: "ğŸ›¡ï¸ CISE Bot Ultimate CI Pipeline"

on:
  push:
    branches: [ "main", "claude/**" ]
    paths:
      - 'study_bot/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main" ]

jobs:
  # ---------------------------------------------------
  # 1. í’ˆì§ˆ ë° ë³´ì•ˆ ì ê²€ (Quality & Security)
  # ---------------------------------------------------
  quality-check:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyflakes flake8 black bandit

      - name: 1ï¸âƒ£ Syntax Check (Flake8)
        # E501: ì¤„ ê¸¸ì´ ì œí•œ ë¬´ì‹œ (ê¸´ ë¬¸ìì—´ í—ˆìš©)
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: 2ï¸âƒ£ Code Formatting Check (Black)
        # ì½”ë“œê°€ í‘œì¤€ í¬ë§·(Black)ì„ ë”°ë¥´ëŠ”ì§€ ê²€ì‚¬
        run: black --check .

      - name: 3ï¸âƒ£ Security Scan (Bandit)
        # ë³´ì•ˆ ê¸°ì‚¬ ë´‡ì´ë¯€ë¡œ ë³´ì•ˆ ì·¨ì•½ì  ì ê²€ í•„ìˆ˜
        # B311: ëœë¤ ëª¨ë“ˆ ì‚¬ìš© ê²½ê³  ë¬´ì‹œ (í€´ì¦ˆ ëœë¤ ì¶œì œìš©)
        run: bandit -r study_bot -s B311

  # ---------------------------------------------------
  # 2. í†µí•© í…ŒìŠ¤íŠ¸ (Matrix Testing)
  # ---------------------------------------------------
  test:
    name: ğŸ§ª Run Unit Tests
    needs: quality-check # í’ˆì§ˆ ì ê²€ì´ í†µê³¼í•´ì•¼ ì‹¤í–‰
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # í•„ìš”í•œ ê²½ìš° requirements.txt ì„¤ì¹˜
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ğŸ“‚ Create Data Directory
        run: mkdir -p study_bot/data

      - name: ğŸ§ª Execute Tests
        # unittest ìë™ ë°œê²¬ ëª¨ë“œë¡œ ì‹¤í–‰
        run: python -m unittest discover tests
