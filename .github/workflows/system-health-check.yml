name: System Health Check

on:
  schedule:
    # 20분 단위로 실행
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      force_rerun:
        description: '문제 발생 시 강제 재수행 여부'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  actions: write
  issues: write  # 이슈 생성 권한 추가

env:
  # 시스템 임계값 설정
  CPU_THRESHOLD: 90
  MEMORY_THRESHOLD: 90
  DISK_THRESHOLD: 85
  INODE_THRESHOLD: 90
  NETWORK_TIMEOUT: 5
  MAX_RETRY_COUNT: 3
  RETRY_DELAY: 30
  # [NEW] 타겟 리포지토리 설정
  TARGET_REPO_URL: "https://github.com/koreatest12/Certified-Information-Security-Engineer-CISE-.git"
  COMMIT_AGE_THRESHOLD: 30  # 마지막 커밋이 30일 지났으면 경고

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    outputs:
      check-failed: ${{ steps.summary.outputs.check_failed }}
      failure-details: ${{ steps.summary.outputs.failure_details }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # 1. CPU Check
      # -------------------------------------------------------------
      - name: CPU Check
        id: cpu_check
        run: |
          echo "========================================="
          echo "  CPU Health Check"
          echo "========================================="
          CPU_CORES=$(nproc)
          echo "CPU Cores: $CPU_CORES"
          CPU_USAGE=$(top -bn2 -d1 | grep "Cpu(s)" | tail -1 | awk '{print $2}' | cut -d'%' -f1)
          echo "CPU Usage: ${CPU_USAGE}%"
          LOAD_AVG=$(cat /proc/loadavg)
          echo "Load Average: $LOAD_AVG"
          
          CPU_INT=${CPU_USAGE%.*}
          if [ "${CPU_INT:-0}" -ge "$CPU_THRESHOLD" ]; then
            echo "::warning::CPU usage ${CPU_USAGE}% exceeds threshold ${CPU_THRESHOLD}%"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "CPU status: OK"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # 2. Memory Check
      # -------------------------------------------------------------
      - name: Memory Check
        id: memory_check
        run: |
          echo "========================================="
          echo "  Memory Health Check"
          echo "========================================="
          free -m
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          USED_MEM=$(free -m | awk '/^Mem:/{print $3}')
          MEM_USAGE_PCT=$(awk "BEGIN {printf \"%.1f\", ($USED_MEM/$TOTAL_MEM)*100}")
          echo "Memory Usage: ${MEM_USAGE_PCT}%"
          
          MEM_INT=${MEM_USAGE_PCT%.*}
          if [ "${MEM_INT:-0}" -ge "$MEMORY_THRESHOLD" ]; then
            echo "::warning::Memory usage ${MEM_USAGE_PCT}% exceeds threshold ${MEMORY_THRESHOLD}%"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "Memory status: OK"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # 3. Disk Check
      # -------------------------------------------------------------
      - name: Disk Check
        id: disk_check
        run: |
          echo "========================================="
          echo "  Disk Health Check"
          echo "========================================="
          df -h
          DISK_WARNING=false
          while IFS= read -r line; do
            USAGE=$(echo "$line" | awk '{print $5}' | tr -d '%')
            MOUNT=$(echo "$line" | awk '{print $6}')
            if [ -n "$USAGE" ] && [ "$USAGE" -ge "$DISK_THRESHOLD" ] 2>/dev/null; then
              echo "::warning::Disk usage on $MOUNT is ${USAGE}%"
              DISK_WARNING=true
            fi
          done < <(df -h | tail -n +2 | grep -v "tmpfs\|udev")
          
          if [ "$DISK_WARNING" = true ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "Disk status: OK"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # 4. Filesystem Check
      # -------------------------------------------------------------
      - name: Filesystem Check
        id: filesystem_check
        run: |
          echo "========================================="
          echo "  Filesystem Health Check"
          echo "========================================="
          df -i
          INODE_WARNING=false
          while IFS= read -r line; do
            USAGE=$(echo "$line" | awk '{print $5}' | tr -d '%')
            MOUNT=$(echo "$line" | awk '{print $6}')
            if [ -n "$USAGE" ] && [ "$USAGE" -ge "$INODE_THRESHOLD" ] 2>/dev/null; then
              echo "::warning::Inode usage on $MOUNT is ${USAGE}%"
              INODE_WARNING=true
            fi
          done < <(df -i | tail -n +2 | grep -v "tmpfs\|udev")
          
          if [ "$INODE_WARNING" = true ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "Filesystem status: OK"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # 5. Network Check
      # -------------------------------------------------------------
      - name: Network Check
        id: network_check
        run: |
          echo "========================================="
          echo "  Network Health Check"
          echo "========================================="
          NETWORK_WARNING=false
          
          # HTTP 연결 확인
          HTTP_TARGETS=("https://github.com" "https://pypi.org")
          for target in "${HTTP_TARGETS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout "$NETWORK_TIMEOUT" "$target" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
              echo "HTTP check $target: OK ($HTTP_CODE)"
            else
              echo "::warning::HTTP check $target: FAILED ($HTTP_CODE)"
              NETWORK_WARNING=true
            fi
          done
          
          if [ "$NETWORK_WARNING" = true ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "Network status: OK"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # 6. Target Repository Check (추가된 기능)
      # -------------------------------------------------------------
      - name: Target Repository Check
        id: repo_check
        run: |
          echo "========================================="
          echo "  Target Repository Health Check"
          echo "========================================="
          echo "Target: ${{ env.TARGET_REPO_URL }}"
          
          REPO_STATUS="ok"
          
          # 1. HTTP 접근성 확인
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.TARGET_REPO_URL }}" || echo "000")
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
            echo "✅ HTTP Accessibility: OK ($HTTP_CODE)"
          else
            echo "❌ HTTP Accessibility: FAILED ($HTTP_CODE)"
            echo "::warning::Repository URL is not accessible via HTTP"
            REPO_STATUS="warning"
          fi
          
          # 2. Git Clone 및 무결성 확인 (Shallow clone)
          echo "--- Git Clone Test ---"
          if git clone --depth 1 "${{ env.TARGET_REPO_URL }}" target_repo_check 2>/dev/null; then
            echo "✅ Git Clone: Success"
            
            cd target_repo_check
            
            # 3. 마지막 커밋 정보 확인
            LAST_COMMIT_DATE=$(git log -1 --format=%cd --date=iso)
            LAST_COMMIT_TS=$(git log -1 --format=%ct)
            CURRENT_TS=$(date +%s)
            DIFF_DAYS=$(( (CURRENT_TS - LAST_COMMIT_TS) / 86400 ))
            
            echo "ℹ️ Last Commit: $LAST_COMMIT_DATE"
            echo "ℹ️ Author: $(git log -1 --format='%an')"
            echo "ℹ️ Days since last commit: $DIFF_DAYS days"
            
            # 4. 활동성 체크 (너무 오래된 커밋인지)
            if [ "$DIFF_DAYS" -gt "${{ env.COMMIT_AGE_THRESHOLD }}" ]; then
              echo "⚠️ Repository hasn't been updated in over ${{ env.COMMIT_AGE_THRESHOLD }} days."
              # 오래된 것은 장애는 아니므로 warning 로그만 남기고 상태는 ok로 유지
            fi
            
            # 5. 필수 파일 존재 여부 (예: README.md)
            if [ -f "README.md" ]; then
              echo "✅ Critical File (README.md): Exists"
            else
              echo "⚠️ README.md not found"
            fi
            
            cd ..
            rm -rf target_repo_check
          else
            echo "❌ Git Clone: FAILED"
            echo "::error::Failed to clone target repository"
            REPO_STATUS="warning"
          fi
          
          echo "status=$REPO_STATUS" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 7. Capacity Summary Check
      # -------------------------------------------------------------
      - name: Capacity Summary Check
        id: capacity_check
        run: |
          echo "========================================="
          echo "  Capacity Overview"
          echo "========================================="
          uptime
          echo "Running processes: $(ps aux | wc -l)"
          echo "status=ok" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 8. Generate Health Report
      # -------------------------------------------------------------
      - name: Generate Health Report
        id: summary
        if: always()
        run: |
          echo "========================================="
          echo "  SYSTEM HEALTH CHECK REPORT"
          echo "  $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "========================================="
          
          CHECK_FAILED=false
          FAILURE_DETAILS=""
          
          # 체크 항목에 TargetRepo 추가
          declare -A CHECKS=(
            ["CPU"]="${{ steps.cpu_check.outputs.status }}"
            ["Memory"]="${{ steps.memory_check.outputs.status }}"
            ["Disk"]="${{ steps.disk_check.outputs.status }}"
            ["Filesystem"]="${{ steps.filesystem_check.outputs.status }}"
            ["Network"]="${{ steps.network_check.outputs.status }}"
            ["TargetRepo"]="${{ steps.repo_check.outputs.status }}"
            ["Capacity"]="${{ steps.capacity_check.outputs.status }}"
          )
          
          echo ""
          echo "+--------------+----------+"
          echo "| Check        | Status   |"
          echo "+--------------+----------+"
          
          # 순서대로 출력
          for check in "CPU" "Memory" "Disk" "Filesystem" "Network" "TargetRepo" "Capacity"; do
            status="${CHECKS[$check]}"
            if [ "$status" = "warning" ]; then
              printf "| %-12s | %-8s |\n" "$check" "WARNING"
              CHECK_FAILED=true
              FAILURE_DETAILS="${FAILURE_DETAILS}${check}, "
            elif [ "$status" = "ok" ]; then
              printf "| %-12s | %-8s |\n" "$check" "OK"
            else
              printf "| %-12s | %-8s |\n" "$check" "UNKNOWN"
              CHECK_FAILED=true
              FAILURE_DETAILS="${FAILURE_DETAILS}${check}(unknown), "
            fi
          done
          echo "+--------------+----------+"
          
          echo "check_failed=$CHECK_FAILED" >> $GITHUB_OUTPUT
          
          if [ "$CHECK_FAILED" = true ]; then
            FAILURE_DETAILS=${FAILURE_DETAILS%, }
            echo "failure_details=$FAILURE_DETAILS" >> $GITHUB_OUTPUT
            echo "::error::Health check issues detected in: $FAILURE_DETAILS"
            echo "RESULT: ISSUES DETECTED"
          else
            echo "failure_details=" >> $GITHUB_OUTPUT
            echo "RESULT: ALL CHECKS PASSED"
          fi

  # -------------------------------------------------------------
  # Force Re-run on Failure (완전한 스크립트)
  # -------------------------------------------------------------
  force-rerun:
    name: Force Re-run on Failure
    needs: health-check
    if: |
      always() &&
      needs.health-check.outputs.check-failed == 'true' &&
      (github.event.inputs.force_rerun != 'false')
    runs-on: ubuntu-latest
    steps:
      - name: Report failure details
        run: |
          echo "Health Check Failed: ${{ needs.health-check.outputs.failure-details }}"
      
      - name: Wait before retry
        run: sleep ${{ env.RETRY_DELAY || 30 }}
      
      - name: Trigger workflow re-run
        uses: actions/github-script@v8
        with:
          script: |
            const MAX_RETRY = parseInt('${{ env.MAX_RETRY_COUNT }}') || 3;
            // 현재 실행의 재시도 횟수를 확인 (run_attempt)
            const currentAttempt = context.runNumber;
            console.log(`Current run attempt info - Run number: ${currentAttempt}`);
            
            // 최근 워크플로우 실행 기록 확인하여 연속 실패 횟수 계산
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'system-health-check.yml',
              per_page: MAX_RETRY + 1,
              status: 'completed'
            });
            
            let consecutiveFailures = 0;
            for (const run of runs.data.workflow_runs) {
              if (run.conclusion === 'failure' || run.conclusion === 'action_required') {
                consecutiveFailures++;
              } else {
                break;
              }
            }
            console.log(`Consecutive failures: ${consecutiveFailures}`);
            console.log(`Max retry count: ${MAX_RETRY}`);
            
            if (consecutiveFailures >= MAX_RETRY) {
              console.log(`Maximum retry count (${MAX_RETRY}) reached. Stopping re-runs.`);
              core.warning(`Health check has failed ${consecutiveFailures} consecutive times. Manual intervention required.`);
              return;
            }
            
            console.log(`Triggering re-run (${consecutiveFailures + 1}/${MAX_RETRY})...`);
            
            // 워크플로우 재실행 트리거
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'system-health-check.yml',
              ref: '${{ github.ref }}',
              inputs: {
                force_rerun: 'true'
              }
            });
            console.log('Re-run triggered successfully.');
            
      - name: Create issue on persistent failure
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const MAX_RETRY = parseInt('${{ env.MAX_RETRY_COUNT }}') || 3;
            
            // 최근 실패 기록 확인
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'system-health-check.yml',
              per_page: MAX_RETRY + 1,
              status: 'completed'
            });
            
            let consecutiveFailures = 0;
            for (const run of runs.data.workflow_runs) {
              if (run.conclusion === 'failure' || run.conclusion === 'action_required') {
                consecutiveFailures++;
              } else {
                break;
              }
            }
            
            // 최대 재시도 횟수 도달 시 이슈 생성
            if (consecutiveFailures >= MAX_RETRY) {
              const failureDetails = '${{ needs.health-check.outputs.failure-details }}';
              const now = new Date().toISOString();
              
              // 기존 열린 이슈 확인
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'system-health,auto-generated',
                state: 'open'
              });
              
              if (existingIssues.data.length > 0) {
                // 기존 이슈에 코멘트 추가
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssues.data[0].number,
                  body: `## Health Check Still Failing\n\n**Time**: ${now}\n**Failed Checks**: ${failureDetails}\n**Consecutive Failures**: ${consecutiveFailures}\n\nManual intervention required.`
                });
                console.log(`Updated existing issue #${existingIssues.data[0].number}`);
              } else {
                // 새 이슈 생성
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Alert] System Health Check Failed - ${failureDetails}`,
                  body: `## System Health Check Failure Report\n\n**Time**: ${now}\n**Failed Checks**: ${failureDetails}\n**Consecutive Failures**: ${consecutiveFailures}\n**Max Retries Reached**: Yes (${MAX_RETRY})\n\n### Action Required\n\nThe system health check has failed ${consecutiveFailures} consecutive times.\nAutomatic retries have been exhausted. Manual investigation is needed.\n\n### Failed Components\n${failureDetails.split(', ').map(c => '- [ ] ' + c).join('\n')}\n\n### Workflow Run\n[View Run Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  labels: ['system-health', 'auto-generated']
                });
                console.log('Created new issue for persistent health check failure.');
              }
            }
