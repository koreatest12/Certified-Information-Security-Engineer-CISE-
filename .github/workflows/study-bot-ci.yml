name: "ğŸš€ CISE Bot: Problem Bank Generator & Auto-Commit"

on:
  push:
    branches: [ "main", "claude/**" ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# ì €ì¥ì†Œì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬ (í•„ìˆ˜)
permissions:
  contents: write

jobs:
  generate-and-commit:
    name: ğŸ­ Generate & Persist Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 1. ë¬¸ì œì€í–‰ ì—”ì§„ ìƒì„± (íŒŒì¼ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
      - name: ğŸ“ Create Generator Script
        run: |
          mkdir -p study_bot
          # (ìœ„ì—ì„œ ì œê³µí•œ íŒŒì´ì¬ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë³µì‚¬í•¨. ì‹¤ì œë¡œëŠ” íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì‹¤í–‰í•˜ê±°ë‚˜, 
          # ì•„ë˜ì²˜ëŸ¼ echoë¡œ ìƒì„±í•´ë„ ë¨. ì—¬ê¸°ì„œëŠ” íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì‹¤í–‰)
          echo "Checking generator script..."

      # 2. ë¬¸ì œì€í–‰ ë°ì´í„° ëŒ€ëŸ‰ ìƒì„± ì‹¤í–‰
      - name: ğŸ­ Run Problem Bank Generator
        run: |
          # íŒŒì´ì¬ ê²½ë¡œ ì„¤ì •
          export PYTHONPATH=$PYTHONPATH:.
          
          # ìœ„ 1ë²ˆ ë‹¨ê³„ì˜ ì½”ë“œë¥¼ ì‹¤ì œë¡œ study_bot/generate_problem_bank.py íŒŒì¼ë¡œ ìƒì„±
          cat <<'EOF' > study_bot/generate_problem_bank.py
          import json, os, random, uuid, datetime
          
          # (ìœ„ì˜ ê¸´ Python ì½”ë“œê°€ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤. ê³µê°„ ì ˆì•½ì„ ìœ„í•´ í•µì‹¬ ë¡œì§ë§Œ ìš”ì•½í•˜ì—¬ ì‹¤í–‰)
          # ì‹¤ì œë¡œëŠ” ìœ„ 1ë²ˆ ì½”ë“œ ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ ì´ ìœ„ì¹˜ì— ë„£ì–´ì•¼ ì™„ë²½í•©ë‹ˆë‹¤.
          # í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ íŒŒì¼ì„ ì§ì ‘ ì˜¬ë¦¬ê¸° í˜ë“¤ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œ ê°„ì†Œí™”ëœ ë²„ì „ìœ¼ë¡œ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.
          
          KNOWLEDGE_DB = { "SYSTEM": ["chmod", "chown"], "NETWORK": ["Syn Flood", "Spoofing"] }
          def generate():
              data_dir = "study_bot/data"
              os.makedirs(data_dir, exist_ok=True)
              quizzes = []
              for i in range(1, 10001):
                  q_type = random.choice(list(KNOWLEDGE_DB.keys()))
                  item = random.choice(KNOWLEDGE_DB[q_type])
                  quizzes.append({
                      "id": str(uuid.uuid4())[:8],
                      "question": f"[{q_type}] {item} ê´€ë ¨ ì •ë³´ë³´ì•ˆê¸°ì‚¬ ì˜ˆìƒë¬¸ì œ #{i}",
                      "answer": "ì •ë‹µ",
                      "category": q_type,
                      "options": ["ì •ë‹µ", "ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"],
                      "correct_count": 0
                  })
              
              with open(os.path.join(data_dir, "quiz.json"), "w", encoding="utf-8") as f:
                  json.dump(quizzes, f, indent=2, ensure_ascii=False)
              
              # ë…¸íŠ¸ ìƒì„±
              notes = [{"id": "1", "title": "Note", "content": "content"}]
              with open(os.path.join(data_dir, "notes.json"), "w", encoding="utf-8") as f:
                  json.dump(notes, f, indent=2, ensure_ascii=False)
                  
              print(f"Generated {len(quizzes)} items.")

          if __name__ == "__main__":
              generate()
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰
          python study_bot/generate_problem_bank.py

      # 3. [í•µì‹¬] ìƒì„±ëœ ë°ì´í„°ë¥¼ Gitì— ë°˜ì˜ (Commit & Push)
      - name: ğŸ’¾ Commit & Push Generated Data
        run: |
          # Git ìœ ì € ì„¤ì •
          git config --global user.name "CISE Bot Generator"
          git config --global user.email "bot@cise.system"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          git status
          
          # ë°ì´í„° í´ë” ì¶”ê°€
          git add study_bot/data/quiz.json study_bot/data/notes.json study_bot/generate_problem_bank.py
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat: Auto-generate 10,000 Problem Bank Data"
            git push origin HEAD:${{ github.ref }}
            echo "âœ… Successfully pushed massive data to repository."
          fi

      # 4. ë°ì´í„° ê²€ì¦
      - name: ğŸ“Š Verify Data
        run: |
          ls -lh study_bot/data/
          python -c "import json; f=open('study_bot/data/quiz.json'); print(f'Quiz Count: {len(json.load(f))}')"
