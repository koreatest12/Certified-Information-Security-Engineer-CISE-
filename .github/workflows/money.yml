name: ğŸ›¡ï¸ UNIVERSE v4000 (PERMISSION CHAOS & FORCE SUCCESS)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions: write-all

env:
  BASE_DIR: universe_v4000_env
  VIRTUAL_DISK_PATH: /mnt/virtual_disks
  DEBIAN_FRONTEND: noninteractive

jobs:
  # ==========================================================
  # 1ï¸âƒ£ INFRA & USER SETUP (ê¶Œí•œ ì£¼ì²´ ìƒì„±)
  # ==========================================================
  infra-permission-setup:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ğŸ›  Install ACL & Attr Tools
        run: sudo apt-get update && sudo apt-get install -y acl attr postgresql-client lvm2 nodejs npm || true

      - name: ğŸ‘¥ Create 50 Dummy Users & Groups (For Ownership)
        run: |
          echo "Generating Users for Chown Tests..."
          # ìœ ì € 1~50 ìƒì„± (ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ)
          for i in {1..50}; do
            sudo useradd -m "dummy_user_$i" || true
            sudo groupadd "dummy_group_$i" || true
          done
          echo "User Swarm Created."

      - name: ğŸ”“ Setup Storage (Fail-Safe)
        run: |
          sudo mkdir -p $VIRTUAL_DISK_PATH
          sudo chmod 777 $VIRTUAL_DISK_PATH
          
          # ë””ìŠ¤í¬ ìƒì„± (ìë™ ë¦¬ì‚¬ì´ì§•)
          for i in {1..5}; do
            truncate -s 50T "$VIRTUAL_DISK_PATH/disk_$i.img" 2>/dev/null || \
            truncate -s 10T "$VIRTUAL_DISK_PATH/disk_$i.img" 2>/dev/null || \
            truncate -s 100G "$VIRTUAL_DISK_PATH/disk_$i.img" || true
          done

  # ==========================================================
  # 2ï¸âƒ£ LOGIC ENGINE (ê¸ˆìœµ/í•™ìŠµ + ê¶Œí•œ í…ŒìŠ¤íŠ¸)
  # ==========================================================
  logic-permission-engine:
    needs: infra-permission-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ§  Money & Study Logic with Locked Files
        run: |
          mkdir -p $BASE_DIR/secure_data
          
          # [ìŠ¤í¬ë¦½íŠ¸] ê¶Œí•œì´ ê±¸ë¦° ë°ì´í„° ìƒì„±
          cat << 'EOF' > secure_logic.js
          const fs = require('fs');
          const path = '${{ env.BASE_DIR }}/secure_data';
          
          try {
            // 1. 2026 ê¸‰ì—¬ ë°ì´í„° (Secure: 600)
            const salaryFile = path + '/salary_2026_secure.csv';
            fs.writeFileSync(salaryFile, 'id,salary,tax\n1,5000000,50000');
            fs.chmodSync(salaryFile, 0o600); // ì†Œìœ ìë§Œ ì½ê¸°/ì“°ê¸°
            
            // 2. ë¶€ê°€ì„¸ ë°ì´í„° (Public: 777)
            const vatFile = path + '/vat_public.csv';
            fs.writeFileSync(vatFile, 'id,vat\n1,1000');
            fs.chmodSync(vatFile, 0o777); // ëˆ„êµ¬ë‚˜ ìˆ˜ì • ê°€ëŠ¥
            
            // 3. ê¸°ë°€ í•™ìŠµ ë…¸íŠ¸ (Locked: 000)
            const secretNote = path + '/top_secret_study.txt';
            fs.writeFileSync(secretNote, 'Exam Cheat Sheet...');
            fs.chmodSync(secretNote, 0o000); // ì•„ë¬´ë„ ëª» ì½ìŒ (Chaos)
            
            console.log("Secure Logic Executed");
          } catch (e) { process.exit(0); }
          EOF
          
          node secure_logic.js || exit 0

  # ==========================================================
  # 3ï¸âƒ£ PERMISSION CHAOS FACTORY (íŒŒì¼ + ê¶Œí•œ ë¬´ì‘ìœ„ ì ìš©)
  # ==========================================================
  file-permission-chaos:
    needs: infra-permission-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      max-parallel: 50
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ›¡ï¸ Generate Files with Random Permissions
        run: |
          TARGET_DIR="$VIRTUAL_DISK_PATH/perm_chaos/shard_${{ matrix.shard }}"
          mkdir -p $TARGET_DIR
          # ìƒìœ„ í´ë” ê¶Œí•œ ê°œë°© (í•˜ìœ„ íŒŒì¼ ìƒì„±ì„ ìœ„í•´)
          sudo chmod 777 $TARGET_DIR
          
          # [ìŠ¤í¬ë¦½íŠ¸] ê¶Œí•œ ë£°ë › íŒŒì¼ ìƒì„±ê¸°
          cat << 'EOF' > perm_gen.js
          const fs = require('fs');
          const { execSync } = require('child_process');
          const path = process.env.TARGET_DIR;
          const count = 10000; // ìƒ¤ë“œë‹¹ 1ë§Œê°œ
          
          const modes = ['777', '755', '644', '600', '400', '000'];
          
          console.log(`Generating ${count} files with mixed permissions...`);
          
          try {
            for (let i = 0; i < count; i++) {
              const file = \`\${path}/file_\${i}.dat\`;
              const content = \`Secure Data Block \${i}\`;
              
              // 1. íŒŒì¼ ìƒì„±
              fs.writeFileSync(file, content);
              
              // 2. ê¶Œí•œ ë¬´ì‘ìœ„ ì ìš© (Chmod Roulette)
              const mode = modes[Math.floor(Math.random() * modes.length)];
              try {
                fs.chmodSync(file, parseInt(mode, 8));
              } catch(e) {}
              
              // 3. ì†Œìœ ê¶Œ ë¬´ì‘ìœ„ ë³€ê²½ (Chown Roulette - Sudo í•„ìš”í•˜ë¯€ë¡œ exec ì‚¬ìš©)
              // 100ë²ˆë§ˆë‹¤ í•œ ë²ˆì”© ì‹¤í–‰ (ì†ë„ ì €í•˜ ë°©ì§€)
              if (i % 100 === 0) {
                 const userId = Math.floor(Math.random() * 50) + 1;
                 try {
                   execSync(\`sudo chown dummy_user_\${userId} \${file}\`);
                 } catch(e) {}
              }
              
              // 4. ë¶ˆë³€ ì†ì„± ì ìš© (Immutable) - 1000ë²ˆë§ˆë‹¤
              if (i % 1000 === 0) {
                 try {
                   execSync(\`sudo chattr +i \${file}\`);
                 } catch(e) {}
              }
            }
          } catch (e) {
            console.log("Error ignored, forcing success.");
            process.exit(0);
          }
          EOF
          
          TARGET_DIR=$TARGET_DIR node perm_gen.js || exit 0

      - name: ğŸ”’ ACL Injection (Access Control Lists)
        run: |
          # ìƒì„±ëœ íŒŒì¼ ì¤‘ ì¼ë¶€ì— ë³µì¡í•œ ACL ê¶Œí•œ ì¶”ê°€
          TARGET_DIR="$VIRTUAL_DISK_PATH/perm_chaos/shard_${{ matrix.shard }}"
          
          # 1. íŠ¹ì • ìœ ì €ì—ê²Œë§Œ ì½ê¸° ê¶Œí•œ ë¶€ì—¬ (setfacl)
          find $TARGET_DIR -name "file_*0.dat" | head -n 100 | xargs -I {} sudo setfacl -m u:dummy_user_1:r {} || true
          
          # 2. íŠ¹ì • ê·¸ë£¹ì—ê²Œ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
          find $TARGET_DIR -name "file_*5.dat" | head -n 100 | xargs -I {} sudo setfacl -m g:dummy_group_5:w {} || true
          
          echo "ACL Injection Complete"

  # ==========================================================
  # 4ï¸âƒ£ FORCE SUCCESS VERIFICATION (ì ‘ê·¼ í…ŒìŠ¤íŠ¸)
  # ==========================================================
  verify-force-success:
    needs: [infra-permission-setup, logic-permission-engine, file-permission-chaos]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ•µï¸ Try to Read Locked Files (Expect Fail -> Force Success)
        run: |
          echo "Attempting to read '000' permission files..."
          # ì ‘ê·¼ ê±°ë¶€(Permission denied)ê°€ ë°œìƒí•˜ì§€ë§Œ || trueë¡œ ë¬´ì‹œ
          cat $VIRTUAL_DISK_PATH/perm_chaos/shard_1/file_*.dat > /dev/null 2>&1 || echo "Access Denied (Expected Chaos)"
          
          echo "Attempting to delete Immutable (+i) files..."
          # ì‚­ì œ ë¶ˆê°€(Operation not permitted) ë°œìƒí•˜ì§€ë§Œ ë¬´ì‹œ
          rm -f $VIRTUAL_DISK_PATH/perm_chaos/shard_1/file_*000.dat 2>/dev/null || echo "Cannot Delete Immutable (Expected)"

      - name: ğŸš€ Release (Force)
        uses: softprops/action-gh-release@v2
        continue-on-error: true
        with:
          tag_name: permission-v4000-${{ github.run_number }}
          body: "Files generated with Random Modes (777, 000, 600) + ACL + Chattr. Force Success."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ ABSOLUTE SUCCESS
        run: |
          echo "==============================================="
          echo "   PERMISSION CHAOS STATUS: GREEN (FORCED)     "
          echo "==============================================="
          echo "   MODES APPLIED: 777, 755, 644, 600, 400, 000 "
          echo "   OWNERSHIP: Rotated among 50 dummy users     "
          echo "   ACL/ATTR: Extended attributes applied       "
          echo "   ACCESS TESTS: Failed but Ignored (Success)  "
          echo "==============================================="
          exit 0
