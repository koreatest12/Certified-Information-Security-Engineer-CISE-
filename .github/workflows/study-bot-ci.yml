name: "ğŸ›¡ï¸ CISE Bot: Massive Data Fix"

on:
  push:
    branches: [ "main", "claude/**" ]
  pull_request:
    branches: [ "main" ]

jobs:
  fix-and-simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì •
      # ---------------------------------------------------
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ---------------------------------------------------
      # 2. [í•µì‹¬] ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ì—”ì§„ ì‹¤í–‰
      # ---------------------------------------------------
      - name: ğŸ§  Run Massive Generator (sample_data.py)
        run: |
          echo "Running generator..."
          
          # 1. ëª¨ë“ˆ ê²½ë¡œ ì¸ì‹ ì„¤ì •
          export PYTHONPATH=$PYTHONPATH:.
          
          # 2. ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìœ„ì—ì„œ ìˆ˜ì •í•œ ì½”ë“œê°€ ì‹¤í–‰ë¨)
          python study_bot/sample_data.py
          
          # 3. íŒŒì¼ ìƒì„± í™•ì¸
          ls -lh study_bot/data/

      # ---------------------------------------------------
      # 3. [ê²€ì¦] ë°ì´í„° ê°œìˆ˜ í™•ì¸ ë° ì‹œë®¬ë ˆì´ì…˜
      # ---------------------------------------------------
      - name: ğŸ¤– Verify & Simulate
        run: |
          cat <<'EOF' > verify.py
          import json
          import sys
          import os

          # ë°ì´í„° ë¡œë“œ
          try:
              with open('study_bot/data/quiz.json', 'r', encoding='utf-8') as f:
                  quizzes = json.load(f)
              with open('study_bot/data/notes.json', 'r', encoding='utf-8') as f:
                  notes = json.load(f)
          except Exception as e:
              print(f"âŒ Error loading files: {e}")
              sys.exit(1)

          q_count = len(quizzes)
          n_count = len(notes)
          
          print(f"ğŸ“Š Loaded: {q_count} Quizzes, {n_count} Notes")

          # [ê²€ì¦ ë¡œì§] 1ë§Œ ê°œ ë¯¸ë§Œì´ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
          if q_count < 9999:
              print("âŒ FAILED: Data count too low! Generator did not work.")
              sys.exit(1)
          
          print("âœ… SUCCESS: Data integrity verified.")
          EOF
          
          python verify.py
