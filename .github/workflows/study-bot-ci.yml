name: "ğŸš€ CISE Bot: Hyper-Server & Auto-Quiz Simulation"

on:
  push:
    branches: [ "main", "claude/**" ]
  pull_request:
    branches: [ "main" ]

jobs:
  upgrade-and-simulate:
    name: ğŸ—ï¸ Server Upgrade & Quiz Simulation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. [Base] í•„ìˆ˜ ì˜ì¡´ì„± ë° í™˜ê²½ ì„¤ì •
      # ---------------------------------------------------
      - name: ğŸ“ Generate requirements.txt
        run: |
          cat <<EOF > requirements.txt
          requests>=2.31.0
          pytest>=7.4.0
          mock>=5.1.0
          flake8>=6.1.0
          black>=23.9.0
          bandit>=1.7.5
          EOF

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---------------------------------------------------
      # 2. [Upgrade] ì„œë²„ ì¸í”„ë¼ ëŒ€ëŸ‰ ì—…ê·¸ë ˆì´ë“œ (Health Check + Logs)
      # ---------------------------------------------------
      - name: ğŸš€ Upgrade Server Infrastructure
        run: |
          echo "Upgrading Server Environment..."
          
          # 2-1. ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¥
          mkdir -p study_bot/data
          mkdir -p server/status
          mkdir -p server/logs/access
          mkdir -p server/logs/error
          mkdir -p server/config/production
          mkdir -p scripts/monitor

          # 2-2. ì„œë²„ ìƒíƒœ íŒŒì¼(PID) ë° ì„¤ì • ìƒì„±
          echo "$$" > server/status/bot.pid
          echo '{"mode": "auto-pilot", "max_threads": 16}' > server/config/production/settings.json

          # 2-3. ì„œë²„ í—¬ìŠ¤ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ìë™ ëª¨ë‹ˆí„°ë§ìš©)
          cat <<'EOF' > scripts/monitor/health_check.sh
          #!/bin/bash
          if [ -f "server/status/bot.pid" ]; then
            echo "âœ… Server is RUNNING (PID: $(cat server/status/bot.pid))"
            echo "ğŸ“Š Disk Usage: $(du -sh study_bot/data)"
            exit 0
          else
            echo "âŒ Server is DOWN"
            exit 1
          fi
          EOF
          chmod +x scripts/monitor/health_check.sh
          
          # 2-4. í—¬ìŠ¤ ì²´í¬ ì‹¤í–‰
          ./scripts/monitor/health_check.sh

      # ---------------------------------------------------
      # 3. [Data] ì§€ì‹ ë°ì´í„° ëŒ€ëŸ‰ ìƒì„± (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
      # ---------------------------------------------------
      - name: ğŸ§  Generate Massive Knowledge Base
        run: |
          cat <<'EOF' > generate_data.py
          import json, random, uuid, os
          from datetime import datetime

          os.makedirs('study_bot/data', exist_ok=True)
          CATEGORIES = ["ì‹œìŠ¤í…œ ë³´ì•ˆ", "ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ", "ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ", "ì •ë³´ë³´ì•ˆ ì¼ë°˜", "ì •ë³´ë³´ì•ˆ ë²•ê·œ"]
          
          # í€´ì¦ˆ 100ê°œ ìƒì„± (ìë™ ì‹¤í–‰ìš©)
          quizzes = []
          for i in range(1, 101):
              cat = random.choice(CATEGORIES)
              quizzes.append({
                  "id": str(uuid.uuid4())[:8],
                  "question": f"{cat} ëª¨ì˜ê³ ì‚¬ ë¬¸ì œ #{i}",
                  "answer": "ì •ë‹µ",
                  "category": cat,
                  "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì •ë‹µ", "ì˜¤ë‹µ3"],
                  "explanation": "í•´ì„¤ì…ë‹ˆë‹¤."
              })
          
          with open('study_bot/data/quiz.json', 'w', encoding='utf-8') as f:
              json.dump(quizzes, f, indent=2, ensure_ascii=False)
          print(f"âœ… Generated {len(quizzes)} Quizzes.")
          EOF
          python generate_data.py

      # ---------------------------------------------------
      # 4. [New] í€´ì¦ˆ ìë™ ì‹¤í–‰ ì‹œë®¬ë ˆì´í„° (Auto-Quiz Execution)
      # ---------------------------------------------------
      - name: ğŸ¤– Run Auto-Quiz Simulation
        run: |
          echo "Starting Quiz Auto-Pilot..."
          
          # í€´ì¦ˆ ìë™ í’€ì´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat <<'EOF' > simulate_quiz.py
          import json
          import random
          import sys
          import os

          # ë°ì´í„° ë¡œë“œ
          try:
              with open('study_bot/data/quiz.json', 'r', encoding='utf-8') as f:
                  quizzes = json.load(f)
          except FileNotFoundError:
              print("âŒ Quiz data not found!")
              sys.exit(1)

          print(f"ğŸ“š Total Questions Loaded: {len(quizzes)}")
          print("="*40)

          # 20ë¬¸ì œ ëœë¤ í’€ì´ ì‹œë®¬ë ˆì´ì…˜
          score = 0
          attempts = 20
          selected_quizzes = random.sample(quizzes, attempts)

          for idx, q in enumerate(selected_quizzes, 1):
              # ë´‡ì´ 80% í™•ë¥ ë¡œ ì •ë‹µì„ ë§ì¶”ë„ë¡ ì‹œë®¬ë ˆì´ì…˜
              is_correct = random.random() < 0.8
              chosen_answer = q['answer'] if is_correct else "ì˜¤ë‹µ"
              
              result_icon = "ğŸŸ¢" if is_correct else "ğŸ”´"
              if is_correct:
                  score += 1
              
              print(f"{result_icon} [Q{idx}] {q['category']}: {q['question']}")
              print(f"   -> Bot Answer: {chosen_answer} (Actual: {q['answer']})")

          print("="*40)
          final_score = (score / attempts) * 100
          print(f"ğŸ† Final Score: {score}/{attempts} ({final_score:.1f}%)")
          
          # ê²°ê³¼ ë¡œê·¸ ì €ì¥
          os.makedirs('server/logs/access', exist_ok=True)
          with open('server/logs/access/quiz_result.log', 'w') as log:
              log.write(f"Simulation finished. Score: {final_score}")

          if final_score < 50:
              print("âš ï¸ Performance too low!")
              sys.exit(1)
          else:
              print("âœ… Quiz Simulation Passed!")
          EOF
          
          # ì‹œë®¬ë ˆì´í„° ì‹¤í–‰
          python simulate_quiz.py

      # ---------------------------------------------------
      # 5. [Test] í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ìƒì„± ë° ê²€ì¦
      # ---------------------------------------------------
      - name: ğŸ§ª Generate & Run Test Suite
        run: |
          mkdir -p tests
          touch tests/__init__.py
          
          # ì„œë²„ ë¡œê·¸ íŒŒì¼ ìƒì„± í™•ì¸ í…ŒìŠ¤íŠ¸
          cat <<'EOF' > tests/test_simulation.py
          import unittest
          import os
          
          class SimulationTest(unittest.TestCase):
              def test_log_created(self):
                  """í€´ì¦ˆ ì‹œë®¬ë ˆì´ì…˜ í›„ ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸"""
                  self.assertTrue(os.path.exists("server/logs/access/quiz_result.log"))
          EOF
          
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          python -m unittest discover tests -v
