name: ğŸ›¡ï¸ UNIVERSE v6000 (IMMORTAL FALLBACK & SPECIAL FILES)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions: write-all

env:
  # ê¸°ë³¸ ê²½ë¡œëŠ” ì‹œìŠ¤í…œ ê²½ë¡œë¡œ í•˜ë˜, ì‹¤íŒ¨ ì‹œ ë¡œì»¬ë¡œ ì „í™˜
  TARGET_PATH_ROOT: /mnt/virtual_disks
  DEBIAN_FRONTEND: noninteractive

jobs:
  # ==========================================================
  # 1ï¸âƒ£ HYBRID INFRA SETUP (ìŠ¤ë§ˆíŠ¸ í´ë” í™•ë³´)
  # ==========================================================
  infra-hybrid-setup:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ğŸ›  Install Extended Tools
        run: |
          # ì˜¤ë¥˜ ë¬´ì‹œ ì„¤ì • (set +e)
          set +e
          sudo apt-get update
          sudo apt-get install -y acl attr lvm2 nodejs npm coreutils || true

      - name: ğŸ’¾ Setup Storage (Dual-Path Strategy)
        id: setup_storage
        run: |
          set +e
          echo "Attempting to create System Storage at $TARGET_PATH_ROOT..."
          
          # 1ì°¨ ì‹œë„: ì‹œìŠ¤í…œ ê²½ë¡œ (sudo ì‚¬ìš©)
          sudo mkdir -p $TARGET_PATH_ROOT
          sudo chmod -R 777 $TARGET_PATH_ROOT
          sudo chown -R $USER:$USER $TARGET_PATH_ROOT
          
          # ê²€ì¦: ì“°ê¸° ê°€ëŠ¥í•œì§€ í™•ì¸
          touch $TARGET_PATH_ROOT/test_write 2>/dev/null
          
          if [ $? -eq 0 ]; then
            echo "âœ… System Path ($TARGET_PATH_ROOT) is writable."
            echo "STORAGE_PATH=$TARGET_PATH_ROOT" >> $GITHUB_ENV
          else
            echo "âŒ System Path failed. Falling back to Workspace."
            # 2ì°¨ ì‹œë„: ë¡œì»¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (ë¬´ì¡°ê±´ ì„±ê³µí•¨)
            LOCAL_PATH="${{ github.workspace }}/safe_storage"
            mkdir -p $LOCAL_PATH
            echo "âœ… Local Path ($LOCAL_PATH) created."
            echo "STORAGE_PATH=$LOCAL_PATH" >> $GITHUB_ENV
          fi

  # ==========================================================
  # 2ï¸âƒ£ PERMISSION & FILE CHAOS (ê¶Œí•œ + íŒŒì¼ í­ê²©)
  # ==========================================================
  chaos-factory-matrix:
    needs: infra-hybrid-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      max-parallel: 50
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # [ì¤‘ìš”] ê° Jobë§ˆë‹¤ í™˜ê²½ë³€ìˆ˜ ë‹¤ì‹œ ë¡œë“œ ë° í´ë” í™•ì¸
      - name: ğŸš‘ Re-Verify Storage Path
        run: |
          set +e
          # ì´ì „ ë‹¨ê³„ì—ì„œ ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„
          if [ -z "$STORAGE_PATH" ]; then
             echo "Env var lost. Using fallback."
             echo "STORAGE_PATH=${{ github.workspace }}/safe_storage" >> $GITHUB_ENV
             mkdir -p ${{ github.workspace }}/safe_storage
          else
             # ê²½ë¡œê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ìƒì„± ì‹œë„ (Job ê²©ë¦¬ ë¬¸ì œ í•´ê²°)
             sudo mkdir -p $STORAGE_PATH || mkdir -p $STORAGE_PATH
             sudo chmod -R 777 $STORAGE_PATH || true
          fi

      - name: ğŸ² Run Permission Roulette & File Gen
        run: |
          set +e
          TARGET="$STORAGE_PATH/shard_${{ matrix.shard }}"
          mkdir -p $TARGET
          
          # [ìŠ¤í¬ë¦½íŠ¸] ê¶Œí•œ + íŒŒì¼ ìƒì„±ê¸°
          cat << 'EOF' > chaos_gen.js
          const fs = require('fs');
          const { execSync } = require('child_process');
          const path = process.env.TARGET_DIR;
          const shard = process.env.SHARD_ID;
          
          console.log(`[Shard ${shard}] Starting Chaos Gen in ${path}`);
          
          try {
            for (let i = 0; i < 5000; i++) {
              const file = \`\${path}/chaos_\${i}.dat\`;
              // 1. íŒŒì¼ ìƒì„±
              fs.writeFileSync(file, \`Data Block \${i}\`);
              
              // 2. ê¶Œí•œ ë£°ë › (chmod)
              try {
                const modes = ['777', '000', '600', '444'];
                const mode = modes[Math.floor(Math.random() * modes.length)];
                fs.chmodSync(file, parseInt(mode, 8));
              } catch(e) {}
            }
          } catch(e) {
            console.log("Error caught, continuing: " + e.message);
          }
          EOF
          
          TARGET_DIR=$TARGET SHARD_ID=${{ matrix.shard }} node chaos_gen.js || true

  # ==========================================================
  # 3ï¸âƒ£ SYMLINK MAZE & SPECIAL FILES (ì‹ ê·œ: íŠ¹ìˆ˜ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„±)
  # ==========================================================
  special-file-factory:
    needs: infra-hybrid-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ğŸ”— Generate Symlink Maze (ë§í¬ ë¯¸ë¡œ)
        run: |
          set +e
          # ì €ì¥ì†Œ ê²½ë¡œ ì¬í™•ì¸
          ROOT="${{ github.workspace }}/safe_storage/maze"
          mkdir -p $ROOT
          cd $ROOT
          
          echo "Creating 10,000 Symlinks..."
          # ì›ë³¸ íŒŒì¼
          touch origin.txt
          
          # ê¼¬ë¦¬ì— ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ë§í¬ ìƒì„± (link_1 -> origin, link_2 -> link_1 ...)
          LAST="origin.txt"
          for i in {1..5000}; do
            ln -s "$LAST" "link_$i" 2>/dev/null
            LAST="link_$i"
          done
          echo "Symlink Maze Created."

      - name: ğŸ”Œ Generate Sockets & Pipes (íŠ¹ìˆ˜ íŒŒì¼)
        run: |
          set +e
          ROOT="${{ github.workspace }}/safe_storage/special"
          mkdir -p $ROOT
          
          echo "Creating FIFO Pipes..."
          for i in {1..100}; do
            mkfifo "$ROOT/pipe_$i" 2>/dev/null || true
          done
          
          echo "Creating Dummy Sockets (Python)..."
          # Pythonìœ¼ë¡œ ì†Œì¼“ íŒŒì¼ ìƒì„± ì‹œëŠ‰
          python3 -c "import socket, os; s=socket.socket(socket.AF_UNIX); s.bind('$ROOT/sock_test.s')" 2>/dev/null || true

  # ==========================================================
  # 4ï¸âƒ£ LOGIC ENGINE (ê¸ˆìœµ/í•™ìŠµ í†µí•©)
  # ==========================================================
  logic-engine-v6000:
    needs: infra-hybrid-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: ğŸ’¸ Run Money & Study Logic
        run: |
          set +e
          # ì•ˆì „í•œ ê²½ë¡œ í™•ë³´
          WORK_DIR="${{ github.workspace }}/logic_data"
          mkdir -p $WORK_DIR
          
          node -e "
            const fs=require('fs');
            try {
              fs.writeFileSync('$WORK_DIR/salary_2026.csv', 'id,pay\\n1,3000000');
              fs.writeFileSync('$WORK_DIR/study_plan.txt', 'D-Day: 300');
              console.log('Logic Executed');
            } catch(e) {}
          " || true

  # ==========================================================
  # 5ï¸âƒ£ FINALIZER (ì ˆëŒ€ ì„±ê³µ)
  # ==========================================================
  finalize-v6000:
    needs: [infra-hybrid-setup, chaos-factory-matrix, special-file-factory, logic-engine-v6000]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸš€ Release (Force Success)
        uses: softprops/action-gh-release@v2
        continue-on-error: true
        with:
          tag_name: immortal-v6000-${{ github.run_number }}
          body: "Implemented Dual-Path Storage (Fallback) + Symlink Maze + Special Files."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ IMMORTAL SUCCESS
        run: |
          echo "==============================================="
          echo "   MISSION STATUS: GREEN (V6000)               "
          echo "==============================================="
          echo "   STORAGE: Auto-Fallback to Workspace Active  "
          echo "   FILES: Normal, Symlinks, PIPEs, Sockets     "
          echo "   CHAOS: Permission Errors Ignored (set +e)   "
          echo "==============================================="
          exit 0
