name: "ğŸš€ CISE Bot: AI Quiz Execution & Report (Every 20m)"

on:
  # ---------------------------------------------------
  # ğŸ•’ [New] 20ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰ ìŠ¤ì¼€ì¤„ëŸ¬ ì¶”ê°€
  # ---------------------------------------------------
  schedule:
    - cron: "*/20 * * * *"
  push:
    branches: [ "main", "claude/**" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ai-simulation-pipeline:
    name: ğŸ¤– AI Generate & Solve (20m Loop)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ---------------------------------------------------
      # 1. [ìƒì„±] ë¬¸ì œì€í–‰ 10,000ê°œ ìƒì„±
      # ---------------------------------------------------
      - name: ğŸ­ Write & Run Generator
        run: |
          mkdir -p study_bot
          
          # ë¬¸ì œ ìƒì„±ê¸° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
          cat <<'EOF' > study_bot/generate_problem_bank.py
          import json, os, random, uuid
          def generate():
              os.makedirs('study_bot/data', exist_ok=True)
              quizzes = []
              cats = ["ì‹œìŠ¤í…œ ë³´ì•ˆ", "ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ", "ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ", "ì •ë³´ë³´ì•ˆ ì¼ë°˜", "ì •ë³´ë³´ì•ˆ ë²•ê·œ"]
              for i in range(1, 10001):
                  c = random.choice(cats)
                  quizzes.append({
                      "id": str(uuid.uuid4())[:8],
                      "question": f"[{c}] AI í…ŒìŠ¤íŠ¸ìš© ë¬¸ì œ #{i} (Time: {random.randint(1000,9999)})",
                      "answer": "ì •ë‹µ",
                      "category": c,
                      "options": ["ì •ë‹µ", "ì˜¤ë‹µ1", "ì˜¤ë‹µ2"]
                  })
              with open('study_bot/data/quiz.json', 'w', encoding='utf-8') as f:
                  json.dump(quizzes, f, indent=2, ensure_ascii=False)
              print(f"Generated {len(quizzes)} quizzes.")
          if __name__ == "__main__": generate()
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰
          python study_bot/generate_problem_bank.py

      # ---------------------------------------------------
      # 2. [ì‹¤í–‰] AI í€´ì¦ˆ ì†”ë²„ ì‘ì„± ë° ì‹¤í–‰
      # ---------------------------------------------------
      - name: ğŸ¤– Run AI Quiz Solver
        run: |
          # AI ì†”ë²„ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
          cat <<'EOF' > study_bot/ai_solver.py
          import json, random, os, datetime
          
          def main():
              base_dir = os.path.dirname(os.path.abspath(__file__))
              data_path = os.path.join(base_dir, 'data', 'quiz.json')
              if not os.path.exists(data_path): return
              
              with open(data_path, 'r', encoding='utf-8') as f: quizzes = json.load(f)
              
              # 100ë¬¸ì œ í’€ì´ ì‹œë®¬ë ˆì´ì…˜
              score = 0
              results = []
              # ë§¤ë²ˆ ë‹¤ë¥¸ ë¬¸ì œë¥¼ í’€ë„ë¡ ëœë¤ ìƒ˜í”Œë§
              for q in random.sample(quizzes, 100):
                  is_correct = random.random() < 0.8 # 80% ì •ë‹µë¥  ì‹œë®¬ë ˆì´ì…˜
                  if is_correct: score += 1
                  results.append(f"- {q['question']} -> {'âœ…' if is_correct else 'âŒ'}")
              
              # ë¦¬í¬íŠ¸ ìƒì„± (ì‹œê°„ í¬í•¨)
              now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              report = f"# ğŸ¤– AI Exam Report\n**Run Time:** {now}\n**Score:** {score}/100\n\n## Details\n" + "\n".join(results[:10])
              
              with open(os.path.join(base_dir, 'ai_exam_report.md'), 'w', encoding='utf-8') as f:
                  f.write(report)
              print(f"AI Report Generated. Score: {score}")

          if __name__ == "__main__": main()
          EOF
          
          # AI ì†”ë²„ ì‹¤í–‰
          python study_bot/ai_solver.py
          
          # ë¡œê·¸ í™•ì¸
          cat study_bot/ai_exam_report.md

      # ---------------------------------------------------
      # 3. [ì €ì¥] ë°ì´í„° ë° ë¦¬í¬íŠ¸ ê°•ì œ ì»¤ë°‹ & í‘¸ì‹œ
      # ---------------------------------------------------
      - name: ğŸ’¾ Force Commit & Push All
        run: |
          git config --global user.name "AI Quiz Bot"
          git config --global user.email "bot@ai.cise"
          
          # 1. íŒŒì¼ ì¶”ê°€
          git add study_bot/generate_problem_bank.py study_bot/ai_solver.py
          git add -f study_bot/data/quiz.json
          git add -f study_bot/ai_exam_report.md
          
          # 2. ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "feat: AI Execution (20m Schedule) - Updated Data & Report"
            
            # [ì¤‘ìš”] 20ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ë¯€ë¡œ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ pull --rebase ìˆ˜í–‰
            git pull origin HEAD:${{ github.ref_name }} --rebase || echo "Rebase skipped"
            
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… Successfully pushed AI analysis report."
          fi
